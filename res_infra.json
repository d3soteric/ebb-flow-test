{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "Create infrastructure for the test environment",
    "Parameters" : {
        "EC2KeyParameter" : {
            "Description" : "Enter the SSH key to be used to access the instance",
            "Type" : "AWS::EC2::KeyPair::KeyName"
        },
        "SGInboundCIDRParameter" : {
            "Description" : "Enter a CIDR range to allow traffic FROM.  No template validation so will break template if invalid",
            "Type" : "String",
            "Default" : "0.0.0.0/0"
        }
    },
    "Resources" : {
        "CreateFlowTestVPC" : {
            "Type" : "AWS::EC2::VPC",
            "Properties" : {
                "CidrBlock" : "10.0.0.0/16",
                "InstanceTenancy" : "default",
                "Tags" : [ {"Key" : "stack", "Value" : { "Ref" : "AWS::StackName"} } ]
            }
        },
        "CreateFlowTestIGW" : {
            "Type" : "AWS::EC2::InternetGateway",
            "Properties" : {
                "Tags" : [ { "Key" : "stack", "Value" : { "Ref" : "AWS::StackName"} } ]
            }
        },
        "CreateFlowTestSubnet" : {
            "Type" : "AWS::EC2::Subnet",
            "DependsOn" : "CreateFlowTestVPC",
            "Properties" : {
                "AvailabilityZone" : "us-east-1a",
                "CidrBlock" : "10.0.1.0/24",
                "MapPublicIpOnLaunch" : "true",
                "VpcId" : { "Ref" : "CreateFlowTestVPC" },
                "Tags" : [ {"Key" : "stack", "Value" : { "Ref" : "AWS::StackName"} } ]
            }
        },
        "CreateFlowTestRouteTable" : {
            "Type" : "AWS::EC2::RouteTable",
            "DependsOn" : ["CreateFlowTestVPC", "CreateFlowTestSubnet"],
            "Metadata" : {"Comment" : "Interestingly enough, it seems like the route table was not being deleted until after the VPC was being attempted to be deleted so it was breaking the delete.  By adding the depends on, the resources are now cleaning up properly on delete"},
            "Properties" : {
                "VpcId" : {"Ref" : "CreateFlowTestVPC"},
                "Tags" : [ {"Key" : "stack", "Value" : { "Ref" : "AWS::StackName"} } ]
            }
        },
        "CreateFlowTestRoute" : { 
            "Type" : "AWS::EC2::Route",
            "DependsOn" : "CreateFlowTestRouteTable",
            "Properties" : {
                "DestinationCidrBlock" : "0.0.0.0/0",
                "GatewayId" : { "Ref" : "CreateFlowTestIGW"},
                "RouteTableId" : {"Ref" : "CreateFlowTestRouteTable"}
                }
        },
        "AttachFlowTestIGW" : {
            "Type" : "AWS::EC2::VPCGatewayAttachment",
            "DependsOn" : "CreateFlowTestVPC",
            "Properties" : {
                "VpcId" : { "Ref" : "CreateFlowTestVPC" },
                "InternetGatewayId" : { "Ref" : "CreateFlowTestIGW"}
            }
        },
        "AttachRouteTable" : {
            "Type" : "AWS::EC2::SubnetRouteTableAssociation",
            "DependsOn" : ["CreateFlowTestRouteTable", "CreateFlowTestSubnet"],
            "Properties" : {
                "RouteTableId" : { "Ref" : "CreateFlowTestRouteTable" },
                "SubnetId" : {"Ref" : "CreateFlowTestSubnet" }
              }
          },
        "CreateSG" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "DependsOn" : "CreateFlowTestVPC",
            "Metadata" : {"Comment" : "Kept getting the error that the parameter groupName cannot be used wit hteh parameter subnet.  Well this error was confusing.  Removed parameter groupName, same error. put groupName back.  Changed Ref to fn::GetAtt because suggested on internet, same error.  removed groupName and used fn::GetAtt and it then got the same error again...so finally changed the parameter in the ec2 instance from SecurityGroups to SecurityGroupIds  worked.  Really lacking in the docs on this one"},
            "Properties" : {
                "GroupDescription" : "Basic SG for allowing SSH",
                "SecurityGroupEgress" : [ { "CidrIp" : "0.0.0.0/0", "Description" : "Basic SG for Outbound All", "IpProtocol" : "-1" } ],
                "SecurityGroupIngress" : [ { "CidrIp" : { "Ref" : "SGInboundCIDRParameter" }, "Description" : "Basic SG for Inbound SSH", "IpProtocol" : "tcp" ,"FromPort" : 22, "ToPort" : 22}],
                "VpcId" : {"Ref" : "CreateFlowTestVPC"},
                "Tags" : [ {"Key" : "stack", "Value" : { "Ref" : "AWS::StackName"} } ]
              }
          },
        "FlowTestEC2" : {
            "Type" : "AWS::EC2::Instance",
            "DependsOn" : ["CreateSG", "CreateFlowTestSubnet"],
            "Properties" : {
                "ImageId" : "ami-062f7200baf2fa504",
                "InstanceType" : "t2.micro",
                "KeyName" : {"Ref" : "EC2KeyParameter"},
                "SubnetId" : {"Ref" : "CreateFlowTestSubnet"},
                "SecurityGroupIds" : [{ "Fn::GetAtt" : ["CreateSG", "GroupId"] }],
                "Tags" : [ {"Key" : "stack", "Value" : { "Ref" : "AWS::StackName"} } ]
              }
          }
    }
}